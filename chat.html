{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm" style="height: 80vh;">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0 fw-bold"><i class="bi bi-chat-quote-fill text-primary me-2"></i>Lapag here hinanaing </h5>
                <div>
                    <span class="badge bg-light text-dark me-2">Logged in as: <strong>{{ nickname }}</strong></span>
                    <a href="/chat/leave" class="btn btn-sm btn-outline-danger">Leave</a>
                </div>
            </div>
            
            <!-- Messages Area -->
            <div class="card-body bg-light overflow-auto" id="chat-box" style="flex: 1;">
                <div class="text-center text-muted mt-5" id="loading-msg">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    Loading messages...
                </div>
            </div>

            <!-- Input Area -->
            <div class="card-footer bg-white p-3">
                <form id="chat-form" class="d-flex gap-2">
                    <input type="text" id="message-input" class="form-control" placeholder="Type a message..." autocomplete="off" required>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-send-fill"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const msgInput = document.getElementById('message-input');
    const currentUser = "{{ nickname }}";
    let lastMsgCount = 0;

    // Function to scroll to bottom
    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Function to fetch messages
    async function fetchMessages() {
        try {
            const response = await fetch('/api/chat');
            const data = await response.json();
            
            if (data.messages) {
                // Only update if we have new messages to avoid flickering
                if (data.messages.length !== lastMsgCount) {
                    const wasAtBottom = chatBox.scrollHeight - chatBox.scrollTop === chatBox.clientHeight;
                    
                    chatBox.innerHTML = data.messages.map(msg => {
                        const isMe = msg.nickname === currentUser;
                        const align = isMe ? 'end' : 'start';
                        const color = isMe ? 'bg-primary text-white' : 'bg-white border';
                        const metaAlign = isMe ? 'text-end' : 'text-start';
                        
                        return `
                            <div class="d-flex flex-column align-items-${align} mb-3">
                                <div class="small text-muted mb-1 ${metaAlign}" style="font-size: 0.75rem;">
                                    ${isMe ? 'You' : msg.nickname}
                                </div>
                                <div class="${color} rounded-3 px-3 py-2 shadow-sm" style="max-width: 75%; word-wrap: break-word;">
                                    ${msg.message}
                                </div>
                            </div>
                        `;
                    }).join('');

                    lastMsgCount = data.messages.length;
                    scrollToBottom();
                }
            }
        } catch (error) {
            console.error('Error fetching chat:', error);
        }
    }

    // Send Message
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = msgInput.value.trim();
        if (!message) return;

        msgInput.value = ''; // Clear input immediately
        
        await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message })
        });
        fetchMessages(); // Refresh immediately
    });

    // Initial load and polling
    fetchMessages();
    setInterval(fetchMessages, 2000); // Poll every 2 seconds
</script>
{% endblock %}