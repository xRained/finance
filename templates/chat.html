{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-body p-3 p-md-4">
        <h4 class="card-title mb-4 fw-bold">Chat Room</h4>
        <div id="chat-window" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; display: flex; flex-direction: column-reverse;">
            <div id="chat-messages">
                <!-- Messages will be loaded here -->
            </div>
        </div>
        <div id="chat-form" class="d-flex gap-2">
            <input type="text" id="nickname" class="form-control" placeholder="Your Name" style="width: 150px;">
            <input type="text" id="message" class="form-control" placeholder="Type a message...">
            <button id="send-button" class="btn btn-primary">Send</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const nicknameInput = document.getElementById('nickname');
    const messageInput = document.getElementById('message');
    const sendButton = document.getElementById('send-button');

    // --- Load initial messages ---
    async function fetchMessages() {
        try {
            const response = await fetch('/chat/join', { method: 'POST' }); // Use POST as per previous fix
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const messages = await response.json();
            renderMessages(messages);
        } catch (error) {
            console.error("Could not fetch messages:", error);
            chatMessages.innerHTML = '<p class="text-danger text-center">Could not load chat.</p>';
        }
    }

    // --- Render messages to the screen ---
    function renderMessages(messages) {
        chatMessages.innerHTML = ''; // Clear old messages
        messages.forEach(msg => {
            const msgElement = document.createElement('div');
            msgElement.classList.add('mb-2');
            
            const timestamp = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            msgElement.innerHTML = `
                <div>
                    <strong class="me-2">${escapeHTML(msg.nickname || 'Anonymous')}</strong>
                    <span class="text-muted small">${timestamp}</span>
                </div>
                <p class="mb-0 ms-1">${escapeHTML(msg.message)}</p>
            `;
            chatMessages.prepend(msgElement); // Prepend to keep new messages at the bottom
        });
    }

    // --- Send a new message ---
    async function sendMessage() {
        const nickname = nicknameInput.value.trim();
        const message = messageInput.value.trim();

        if (!nickname || !message) {
            alert('Please enter your name and a message.');
            return;
        }

        try {
            await fetch('/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ nickname, message }),
            });
            messageInput.value = ''; // Clear input
            fetchMessages(); // Refresh messages immediately
        } catch (error) {
            console.error("Could not send message:", error);
        }
    }

    // --- Utility to escape HTML ---
    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, function(match) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
        });
    }

    // --- Event Listeners ---
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') { sendMessage(); }
    });

    // --- Initial Load & Polling ---
    fetchMessages();
    setInterval(fetchMessages, 5000); // Poll for new messages every 5 seconds
});
</script>
{% endblock %}